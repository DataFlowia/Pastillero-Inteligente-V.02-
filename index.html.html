<!DOCTYPE html>
<html lang="es" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>El Pastillero Inteligente</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: #000; color: #67e8f9; min-height: 100vh; overflow-x: hidden; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    .container { max-width: 1152px; margin: 0 auto; padding: 0 1rem; width: 100%; }
    .topbar { position: sticky; top: 0; z-index: 40; background: rgba(0,0,0,0.95); backdrop-filter: blur(10px); border-bottom: 1px solid #155e75; -webkit-backdrop-filter: blur(10px); }
    .topbar-content { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; max-width: 1152px; margin: 0 auto; }
    .logo { display: flex; align-items: center; gap: 0.5rem; color: #22d3ee; font-weight: 600; font-size: 0.9rem; }
    .nav { margin-left: auto; display: flex; gap: 0.5rem; }
    .mobile-menu-btn { display: none; margin-left: auto; background: none; border: none; color: #22d3ee; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; -webkit-tap-highlight-color: transparent; }
    .mobile-menu { position: fixed; top: 0; right: -100%; width: 80%; max-width: 300px; height: 100vh; background: rgba(0,0,0,0.98); border-left: 1px solid #155e75; transition: right 0.3s ease; z-index: 50; overflow-y: auto; -webkit-overflow-scrolling: touch; }
    .mobile-menu.open { right: 0; }
    .mobile-menu-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid #155e75; }
    .mobile-menu-close { background: none; border: none; color: #22d3ee; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; }
    .mobile-menu-items { padding: 1rem; }
    .mobile-menu-item { display: block; width: 100%; text-align: left; padding: 0.875rem 1rem; margin-bottom: 0.5rem; border-radius: 0.75rem; color: #67e8f9; background: transparent; border: 1px solid transparent; font-size: 1rem; cursor: pointer; transition: all 0.2s; -webkit-tap-highlight-color: transparent; }
    .mobile-menu-item:active { transform: scale(0.98); }
    .mobile-menu-item.active { background: #06b6d4; color: #000; border-color: #06b6d4; }
    .mobile-menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 45; display: none; }
    .mobile-menu-overlay.show { display: block; }
    .nav-btn { padding: 0.375rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; border: none; cursor: pointer; color: #67e8f9; background: transparent; }
    .nav-btn:hover { background: rgba(6,182,212,0.1); }
    .nav-btn.active { background: #06b6d4; color: #000; }
    .neon-card { border-radius: 1rem; border: 1px solid rgba(14,116,144,0.6); background: linear-gradient(to bottom right, #000, rgba(8,51,68,0.3)); box-shadow: 0 0 30px rgba(34,211,238,0.35); padding: 1.25rem; margin-bottom: 1rem; width: 100%; box-sizing: border-box; }
    .btn { padding: 0.5rem 1rem; border-radius: 0.75rem; font-weight: 500; cursor: pointer; border: none; transition: all 0.2s; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    .btn:active { transform: scale(0.98); }
    .btn-back { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.75rem; background: rgba(6,182,212,0.1); color: #22d3ee; border: 1px solid #155e75; font-size: 0.875rem; cursor: pointer; transition: all 0.2s; margin-bottom: 1rem; }
    .btn-back:hover { background: rgba(6,182,212,0.2); border-color: #22d3ee; }
    .btn-primary { background: #06b6d4; color: #000; box-shadow: 0 0 30px rgba(34,211,238,0.35); }
    .btn-primary:hover { background: #22d3ee; }
    .btn-secondary { background: transparent; color: #67e8f9; border: 1px solid #155e75; }
    .btn-secondary:hover { background: rgba(6,182,212,0.1); }
    .btn-danger { background: #d72626; color: #fff; box-shadow: 0 10px 30px rgba(215,38,38,0.35); }
    .btn-danger:hover { background: #b51f1f; }
    .btn-outline { background: transparent; color: #4338ca; border: 1px solid #4338ca; box-shadow: 0 10px 30px rgba(67,56,202,0.1); }
    .btn-outline:hover { background: rgba(67,56,202,0.08); }
    input, select, textarea { width: 100%; padding: 0.5rem 0.75rem; border-radius: 0.75rem; border: 1px solid #155e75; background: #000; color: #e0f2fe; font-size: 0.875rem; outline: none; }
    input:focus, select:focus, textarea:focus { border-color: #06b6d4; box-shadow: 0 0 0 3px rgba(6,182,212,0.1); }
    input::placeholder, textarea::placeholder { color: #164e63; }
    label { display: block; margin-bottom: 0.5rem; }
    .label-text { font-size: 0.75rem; font-weight: 500; color: #22d3ee; display: block; margin-bottom: 0.25rem; }
    textarea { min-height: 100px; resize: vertical; }
    .modal-overlay { position: fixed; inset: 0; z-index: 50; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; padding: 1rem; overflow-y: auto; -webkit-overflow-scrolling: touch; }
    .modal-overlay.show { display: flex; }
    .modal { width: 100%; max-width: 768px; max-height: 90vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1.25rem; border-bottom: 1px solid #155e75; }
    .modal-close { background: none; border: none; color: #22d3ee; font-size: 1.5rem; cursor: pointer; padding: 0; }
    .modal-body { padding: 1.25rem; }
    .modal-footer { padding: 0 1.25rem 1.25rem; display: flex; gap: 0.5rem; justify-content: flex-end; }
    .grid { display: grid; gap: 1rem; width: 100%; }
    .grid-2 { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .grid-3 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    .grid-1 { grid-template-columns: 1fr; }
    .boton-vida { width: 11rem; height: 11rem; border-radius: 50%; background: #06b6d4; color: #000; border: none; cursor: pointer; position: relative; box-shadow: 0 20px 60px rgba(34,211,238,0.35); transition: transform 0.2s; }
    .boton-vida:hover { transform: scale(1.05); }
    .boton-vida-content { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
    .boton-vida-icon { font-size: 3rem; margin-bottom: 0.5rem; }
    .pill { display: inline-flex; align-items: center; padding: 0.25rem 0.625rem; border-radius: 0.75rem; background: rgba(6,182,212,0.1); color: #e0f2fe; font-size: 0.75rem; margin: 0.25rem; }
    .toast { position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%); background: #06b6d4; color: #000; padding: 0.5rem 1rem; border-radius: 9999px; box-shadow: 0 0 30px rgba(34,211,238,0.35); z-index: 100; display: none; }
    .toast.show { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    table { width: 100%; border-collapse: collapse; font-size: 0.875rem; overflow-x: auto; display: block; }
    @media (min-width: 768px) { table { display: table; } }
    th { text-align: left; padding: 0.5rem; color: #22d3ee; white-space: nowrap; }
    td { padding: 0.5rem; border-top: 1px solid #164e63; }
    .text-center { text-align: center; }
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .gap-2 { gap: 0.5rem; }
    .gap-3 { gap: 0.75rem; }
    .mt-2 { margin-top: 0.5rem; }
    .mt-3 { margin-top: 0.75rem; }
    .mt-4 { margin-top: 1rem; }
    .mb-4 { margin-bottom: 1rem; }
    .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
    .hidden { display: none; }
    .font-bold { font-weight: 700; }
    .text-sm { font-size: 0.875rem; }
    .text-xs { font-size: 0.75rem; }
    .text-lg { font-size: 1.125rem; }
    .text-2xl { font-size: 1.5rem; }
    .text-cyan-200 { color: #e0f2fe; }
    .text-cyan-300 { color: #67e8f9; }
    .text-cyan-400 { color: #22d3ee; }
    .text-red-400 { color: #f87171; }
    .text-slate-200 { color: #e2e8f0; }
    .card-soft { background: #0b1220; border-radius: 0.75rem; padding: 0.75rem 1rem; border: 1px solid #dbeafe; color: #0f172a; }
    .card-soft-title { color: #1d4ed8; font-weight: 700; }
    .badge { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.25rem 0.6rem; border-radius: 999px; font-size: 0.75rem; background: rgba(6,182,212,0.12); color: #e0f2fe; border: 1px solid rgba(6,182,212,0.25); }
    /* Toggle estilo switch */
    .switch { position: relative; display: inline-block; width: 46px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; inset: 0; background: #1e293b; transition: .2s; border-radius: 34px; border: 1px solid #0ea5e9; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .2s; border-radius: 50%; }
    input:checked + .slider { background: #2563eb; }
    input:checked + .slider:before { transform: translateX(22px); }
    /* Pills for actions */
    .action-pill { display:inline-flex; align-items:center; justify-content:center; width:34px; height:34px; border-radius:50%; border:none; cursor:pointer; }
    .pill-edit { background:#fef9c3; color:#ca8a04; }
    .pill-delete { background:#fee2e2; color:#dc2626; }
    .pill-icon { font-size:15px; }
    @media (max-width: 768px) {
      .nav { display: none; }
      .mobile-menu-btn { display: block; }
      .grid-2, .grid-3 { grid-template-columns: 1fr; }
      .boton-vida { width: 9rem; height: 9rem; }
      .boton-vida-icon { font-size: 2.5rem; }
      .modal { max-width: 100%; margin: 0; }
      .flex-col-mobile { flex-direction: column; align-items: stretch !important; }
      .flex-col-mobile > * { width: 100%; }
    }
    @media (max-width: 480px) {
      .container { padding: 0 0.75rem; }
      .neon-card { padding: 1rem; }
      .text-2xl { font-size: 1.25rem; }
      table { font-size: 0.75rem; }
      th, td { padding: 0.375rem; }
    }
  </style>
</head>
<body>
  <div class="mobile-menu-overlay" id="mobileMenuOverlay" onclick="closeMobileMenu()"></div>
  <div class="mobile-menu" id="mobileMenu">
    <div class="mobile-menu-header">
      <span class="text-cyan-400 font-bold">Men√∫</span>
      <button class="mobile-menu-close" onclick="closeMobileMenu()">‚úï</button>
    </div>
    <div class="mobile-menu-items" id="mobileMenuItems"></div>
  </div>

  <div class="topbar">
    <div class="topbar-content">
      <div class="logo"><span>El Pastillero Inteligente</span></div>
      <nav class="nav" id="nav"></nav>
      <button class="mobile-menu-btn" onclick="openMobileMenu()">‚ò∞</button>
      <button class="nav-btn" onclick="toggleTheme()" id="themeBtn">üåô</button>
    </div>
  </div>

  <main class="container py-8" id="main"></main>

  <footer style="text-align: center; font-size: 0.75rem; padding: 2rem 1rem; border-top: 1px solid #155e75; color: #06b6d4;">
    <div style="margin-bottom: 0.5rem;">¬© 2025 - Todos los derechos reservados</div>
    <div style="display: flex; justify-content: center; align-items: center; gap: 1rem; flex-wrap: wrap;">
      <a href="https://www.dataflowia.com" target="_blank" rel="noopener noreferrer" style="color: #22d3ee; text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='#06b6d4'" onmouseout="this.style.color='#22d3ee'">www.dataflowia.com</a>
      <span style="color: #155e75;">‚Ä¢</span>
      <a href="mailto:contacto@dataflowia.com" style="color: #22d3ee; text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='#06b6d4'" onmouseout="this.style.color='#22d3ee'">contacto@dataflowia.com</a>
    </div>
  </footer>

  <div class="toast" id="toast"></div>

  <script>
    const STORAGE_KEY = 'pastillero_dark_v3';
    const SETTINGS_KEY = 'pastillero_settings_v3';
    const TABS = ['Inicio', 'Pacientes', 'Medicamentos', 'Signos Vitales', 'Agenda M√©dica', 'Farmacia', 'Ajustes'];
    const uid = () => Math.random().toString(36).slice(2, 10);

    const initialSeed = {
      sosContact: { nombre: 'Contacto SOS', telefono: '+56911112222', whatsapp: '', relacion: 'Familiar', centro: '', notas: '' },
      patients: [
        { id: uid(), name: 'Ana Garc√≠a', age: 72, sex: 'Femenino', phone: '+56987654321', email: 'ana.garcia@example.com',
          emergency: { name: 'Carlos Garc√≠a', relation: 'Hijo', phone: '+56912345678', whatsapp: '+56912345678', email: 'carlos.garcia@example.com' },
          pathologies: [{ id: uid(), name: 'Hipertensi√≥n', date: '2021-05-02' }, { id: uid(), name: 'Diabetes Tipo 2', date: '2020-11-10' }],
          allergies: ['Penicilina', 'AINEs'],
          diagnoses: [], notes: 'Paciente estable' }
      ],
      meds: [
        { id: uid(), name: 'Losart√°n', dose: '50mg', freq: 'Diaria', schedules: ['08:00'], permanent: true, active: true, start: '', end: '', patientId: null }
      ],
      vitals: [
        { id: uid(), patientId: null, datetime: new Date().toISOString(), bpSys: 130, bpDia: 85, hr: 75, rr: 16, temp: 36.8, spo2: 98, hgt: 110, notes: 'Rutina' }
      ],
      agenda: [
        { id: uid(), fecha: new Date().toISOString().slice(0,10), hora: '10:00', doctor: 'Dra. Valentina Rivas', especialidad: 'Cardiolog√≠a', consulta: 'Control mensual', direccion: 'Av. Providencia 1234, Santiago', telefono: '+56223456789', observaciones: 'Llevar ex√°menes' }
      ]
    };

    const initialSettings = { theme: 'dark', sounds: true, user: { nombre: '', centro: '', medico: '' } };

    let state = JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null') || initialSeed;
    let settings = JSON.parse(localStorage.getItem(SETTINGS_KEY) || 'null') || initialSettings;
    let currentTab = 'Inicio';
    let editingMedId = null; // para editar f√°rmacos
    let editingPatientId = null; // para editar pacientes

    const saveState = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    const saveSettings = () => localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));

    function notify(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 1600);
    }

    function playBeep() {
      if (!settings.sounds) return;
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator(); const gain = ctx.createGain();
        osc.type = 'sine'; osc.frequency.value = 880; gain.gain.value = 0.05;
        osc.connect(gain); gain.connect(ctx.destination);
        osc.start(); setTimeout(() => osc.stop(), 160);
      } catch(e) {}
    }

    function playSiren() {
      if (!settings.sounds) return;
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator(); const gain = ctx.createGain();
        osc.type = 'sawtooth'; gain.gain.value = 0.03;
        osc.connect(gain); gain.connect(ctx.destination);
        const start = ctx.currentTime; osc.start();
        const sweep = () => {
          const t = ctx.currentTime - start;
          osc.frequency.setValueAtTime(600 + 400 * Math.sin(t * 6), ctx.currentTime);
          if ((ctx.currentTime - start) * 1000 < 900) requestAnimationFrame(sweep); else osc.stop();
        };
        sweep();
      } catch(e) {}
    }

    function toggleTheme() {
      settings.theme = settings.theme === 'dark' ? 'light' : 'dark';
      document.documentElement.classList.toggle('dark', settings.theme === 'dark');
      document.getElementById('themeBtn').textContent = settings.theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
      saveSettings();
    }

    function renderNav() {
      document.getElementById('nav').innerHTML = TABS.map(t =>
        `<button class="nav-btn ${currentTab === t ? 'active' : ''}" onclick="setTab('${t}')">${t}</button>`
      ).join('');
      document.getElementById('mobileMenuItems').innerHTML = TABS.map(t =>
        `<button class="mobile-menu-item ${currentTab === t ? 'active' : ''}" onclick="setTab('${t}'); closeMobileMenu();">${t}</button>`
      ).join('');
    }

    const openMobileMenu = () => { document.getElementById('mobileMenu').classList.add('open'); document.getElementById('mobileMenuOverlay').classList.add('show'); document.body.style.overflow='hidden'; };
    const closeMobileMenu = () => { document.getElementById('mobileMenu').classList.remove('open'); document.getElementById('mobileMenuOverlay').classList.remove('show'); document.body.style.overflow=''; };

    function setTab(tab) { currentTab = tab; renderNav(); render(); }

    function render() {
      const main = document.getElementById('main');
      if (currentTab === 'Inicio') main.innerHTML = renderHome();
      else if (currentTab === 'Pacientes') main.innerHTML = renderPatients();
      else if (currentTab === 'Medicamentos') main.innerHTML = renderMedicines();
      else if (currentTab === 'Signos Vitales') main.innerHTML = renderVitals();
      else if (currentTab === 'Agenda M√©dica') main.innerHTML = renderAgenda();
      else if (currentTab === 'Farmacia') main.innerHTML = renderFarmacia();
      else if (currentTab === 'Ajustes') main.innerHTML = renderAjustes();
    }

    /* -------- HOME -------- */
    function renderHome() {
      const tiles = [
        { label: 'Pacientes', tab: 'Pacientes', icon: 'üë§' },
        { label: 'Medicamentos', tab: 'Medicamentos', icon: 'üíä' },
        { label: 'Signos Vitales', tab: 'Signos Vitales', icon: '‚ù§Ô∏è' },
        { label: 'Agenda M√©dica', tab: 'Agenda M√©dica', icon: 'üìÖ' },
        { label: 'Buscar Farmacia', tab: 'Farmacia', icon: 'üè™' },
        { label: 'Ajustes', tab: 'Ajustes', icon: '‚öôÔ∏è' }
      ];
      return `
        <div style="display:flex; flex-direction:column; align-items:center; padding:2rem 0; gap:1rem;">
          <button class="boton-vida" onclick="activarSOS()">
            <div class="boton-vida-content">
              <div class="boton-vida-icon">ü§ö</div>
              <div style="font-weight:600; font-size:1.25rem;">Bot√≥n de Vida</div>
            </div>
          </button>
          <button class="btn btn-secondary" style="border-radius:999px;" onclick="showMedReminders()">üïë Ver recordatorio de medicamentos</button>
        </div>
        <div style="max-width: 768px; margin: 0 auto;">
          ${tiles.map(t => `
            <div class="neon-card" style="cursor: pointer;" onclick="setTab('${t.tab}')">
              <div class="flex items-center gap-3">
                <span style="display:inline-flex; align-items:center; justify-content:center; width:2.25rem; height:2.25rem; border-radius:0.5rem; background: rgba(6,182,212,0.1); font-size:1.125rem;">${t.icon}</span>
                <span class="text-cyan-200" style="font-weight:500;">${t.label}</span>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    /* -------- SOS MODAL -------- */
    function activarSOS() {
      playSiren();
      notify('Emergencia SOS');
      showSosCallModal();
    }

    function formatPhone(tel='') { return tel.replace(/[^0-9+]/g,''); }

    function getPatientEmergency(p) {
      return p?.emergency && (p.emergency.phone || p.emergency.whatsapp || p.emergency.name)
        ? p.emergency
        : { name: state.sosContact.nombre, relation: state.sosContact.relacion, phone: state.sosContact.telefono, whatsapp: state.sosContact.whatsapp || state.sosContact.telefono, email: state.sosContact.email || '' };
    }

    function showSosCallModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay show';
      const selectOptions = state.patients.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
      const firstId = state.patients[0]?.id || '';
      modal.innerHTML = `
        <div class="neon-card modal" style="background:#0b1220;">
          <div class="modal-header">
            <h2 class="text-lg font-bold text-cyan-200">Llamada de Emergencia SOS</h2>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">‚úï</button>
          </div>
          <div class="modal-body" id="sos-body">
            <label><span class="label-text">Seleccionar Paciente</span>
              <select id="sos-patient" onchange="renderSosContactCard()">
                ${selectOptions}
              </select>
            </label>
            <div id="sos-contact-card" class="mt-3"></div>
            <div class="mt-3 flex flex-col gap-2">
              <button class="btn btn-danger" style="width:100%; font-size:1rem; height:3rem; display:flex; align-items:center; justify-content:center; gap:0.5rem;" onclick="callEmergency()">
                ‚òéÔ∏è LLAMAR A CONTACTO
              </button>
              <button class="btn btn-outline" style="width:100%; font-size:1rem; height:3rem; display:flex; align-items:center; justify-content:center; gap:0.5rem;" onclick="openIAAssistant()">
                üé§ HABLAR CON ASISTENTE IA
              </button>
              <button class="btn btn-secondary" style="width:100%; font-size:0.95rem; height:2.75rem;" onclick="showMedReminders()">üïë Recordatorio de medicamentos</button>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cerrar</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      const sel = modal.querySelector('#sos-patient'); if (firstId) sel.value = firstId;
      renderSosContactCard();
    }

    function renderSosContactCard() {
      const sel = document.getElementById('sos-patient');
      const pid = sel?.value;
      const p = state.patients.find(x => x.id === pid);
      const em = getPatientEmergency(p);
      const card = document.getElementById('sos-contact-card');
      card.innerHTML = `
        <div class="card-soft" style="background:#e8f1ff; color:#0f172a; border-color:#cbd5e1;">
          <div class="text-sm" style="color:#475569; margin-bottom:0.25rem;">Contacto de Emergencia:</div>
          <div class="card-soft-title" style="font-size:1.1rem;">${em.name || 'No definido'}</div>
          <div style="color:#1d4ed8; font-weight:600;">${em.relation || ''}</div>
          <div style="color:#0f172a; margin-top:0.35rem;">${em.phone || em.whatsapp || 'Sin tel√©fono'}</div>
        </div>
      `;
    }

    function callEmergency() {
      const pid = document.getElementById('sos-patient')?.value;
      const p = state.patients.find(x => x.id === pid);
      const em = getPatientEmergency(p);
      const phone = formatPhone(em.phone || em.whatsapp || '');
      if (phone) window.open(`tel:${phone}`, '_blank');
      else notify('No hay tel√©fono disponible');
    }

    function openIAAssistant() {
      const pid = document.getElementById('sos-patient')?.value;
      const p = state.patients.find(x => x.id === pid);
      const em = getPatientEmergency(p);
      const meds = state.meds.filter(m => !m.patientId || m.patientId === pid);
      const agendaNext = state.agenda[0];
      const medsText = meds.length ? meds.map(m => `‚Ä¢ ${m.name} ${m.dose} (${m.freq})${m.schedules.length ? ' a las ' + m.schedules.join(', ') : ''}`).join('\\n') : 'No hay f√°rmacos registrados.';
      const agendaText = agendaNext ? `Pr√≥xima cita: ${agendaNext.fecha} ${agendaNext.hora} con ${agendaNext.doctor} (${agendaNext.especialidad})` : 'Sin citas pr√≥ximas.';
      const msg = `Soy tu asistente.\\nPaciente: ${p?.name || 'N/D'}\\nContacto SOS: ${em.name || 'N/D'} (${em.relation || ''})\\nMedicamentos:\\n${medsText}\\n${agendaText}`;
      const modal = document.createElement('div');
      modal.className = 'modal-overlay show';
      modal.innerHTML = `
        <div class="neon-card modal">
          <div class="modal-header">
            <h2 class="text-lg font-bold text-cyan-200">Asistente IA</h2>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">‚úï</button>
          </div>
          <div class="modal-body">
            <pre style="white-space:pre-wrap; background:rgba(6,182,212,0.05); border:1px solid #155e75; padding:1rem; border-radius:0.75rem; color:#e2e8f0;">${msg}</pre>
            <p class="text-sm text-cyan-300 mt-3">Puedes llamar al contacto o revisar los horarios de medicamentos.</p>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" onclick="showMedReminders(); this.closest('.modal-overlay').remove()">Ver recordatorios</button>
            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cerrar</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    /* -------- MED REMINDERS -------- */
    function getTodayMedReminders() {
      const items = [];
      state.meds.filter(m => m.active).forEach(m => {
        (m.schedules || []).forEach(hh => {
          items.push({ time: hh, med: m.name, dose: m.dose, freq: m.freq });
        });
      });
      return items.sort((a,b) => a.time.localeCompare(b.time));
    }

    function showMedReminders() {
      const reminders = getTodayMedReminders();
      const modal = document.createElement('div');
      modal.className = 'modal-overlay show';
      modal.innerHTML = `
        <div class="neon-card modal">
          <div class="modal-header">
            <h2 class="text-lg font-bold text-cyan-200">Recordatorios de hoy</h2>
          <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">‚úï</button>
          </div>
          <div class="modal-body">
            ${reminders.length === 0 ? '<p class="text-cyan-300">No hay horarios cargados.</p>' : ''}
            ${reminders.map(r => `
              <div class="neon-card" style="margin-bottom:0.5rem; padding:0.75rem;">
                <div class="flex justify-between items-center">
                  <div>
                    <div class="text-cyan-200 font-bold">${r.med}</div>
                    <div class="text-sm text-cyan-300">${r.dose} ‚Ä¢ ${r.freq}</div>
                  </div>
                  <div class="badge">‚è∞ ${r.time}</div>
                </div>
              </div>
            `).join('')}
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cerrar</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    /* -------- PATIENTS -------- */
    function renderPatients() {
      return `
        <button class="btn-back" onclick="setTab('Inicio')"><span>‚Üê</span><span>Volver al Inicio</span></button>
        <div class="flex justify-between items-center mb-4 flex-col-mobile">
          <div class="mb-4">
            <h2 class="text-2xl font-bold text-cyan-200">Gesti√≥n de Pacientes</h2>
            <p style="color: rgba(34, 211, 238, 0.8);">Administra la informaci√≥n de los pacientes y sus tratamientos.</p>
          </div>
          <button class="btn btn-primary" onclick="showAddPatient()">+ Nuevo Paciente</button>
        </div>
        <div class="grid grid-2">
          ${state.patients.map(p => `
            <div class="neon-card">
              <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-3">
                  <div style="width:2.5rem; height:2.5rem; border-radius:50%; background: rgba(6,182,212,0.1); display:flex; align-items:center; justify-content:center; font-size:1.25rem;">üë§</div>
                  <div>
                    <div class="font-bold text-cyan-200">${p.name}</div>
                    <div class="text-sm text-cyan-400">Edad: ${p.age} ‚Ä¢ ${p.sex}</div>
                    <div class="text-sm text-cyan-400">üìû ${p.phone || '‚Äî'} ‚Ä¢ ‚úâÔ∏è ${p.email || '‚Äî'}</div>
                    <div class="text-sm text-cyan-400">‚ù§Ô∏è ${p.pathologies.length} patolog√≠a(s) ‚Ä¢ ‚ö†Ô∏è ${p.allergies?.length || 0} alergia(s)</div>
                    ${p.emergency?.phone || p.emergency?.whatsapp || p.emergency?.name ? `
                      <div class="text-xs text-cyan-400 mt-1">SOS: ${p.emergency.name || '‚Äî'} (${p.emergency.relation || '‚Äî'}) ‚Ä¢ Tel: ${p.emergency.phone || '‚Äî'} ‚Ä¢ WA: ${p.emergency.whatsapp || '‚Äî'}</div>
                    ` : ''}
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <button class="action-pill pill-edit" title="Editar" onclick="showEditPatient('${p.id}')"><span class="pill-icon">‚úé</span></button>
                  <button class="action-pill pill-delete" title="Eliminar" onclick="deletePatient('${p.id}')"><span class="pill-icon">üóë</span></button>
                </div>
              </div>
              ${p.pathologies.length > 0 ? `
                <div style="margin-top:0.75rem; padding-top:0.75rem; border-top:1px solid #155e75;">
                  ${p.pathologies.map(pt => `<span class="pill">${pt.name}</span>`).join('')}
                </div>
              ` : ''}
              ${p.allergies && p.allergies.length > 0 ? `
                <div style="margin-top:0.5rem;">
                  ${p.allergies.map(a => `<span class="pill" style="background: rgba(248,113,113,0.1); color:#fca5a5;">${a}</span>`).join('')}
                </div>
              ` : ''}
            </div>
          `).join('')}
        </div>
      `;
    }

    function showAddPatient() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay show';
      modal.innerHTML = `
        <div class="neon-card modal">
          <div class="modal-header">
            <h2 class="text-lg font-bold text-cyan-400">Agregar Nuevo Paciente</h2>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">‚úï</button>
          </div>
          <div class="modal-body">
            <h3 class="text-cyan-200 font-bold mb-2">Informaci√≥n B√°sica</h3>
            <div class="grid grid-3">
              <label><span class="label-text">Nombre Completo *</span><input id="p-name" placeholder="Ej: Juan P√©rez"></label>
              <label><span class="label-text">Edad *</span><input type="number" id="p-age" placeholder="Ej: 65"></label>
              <label><span class="label-text">Sexo *</span>
                <select id="p-sex">
                  <option value="">Seleccionar</option>
                  <option>Femenino</option>
                  <option>Masculino</option>
                  <option>Otro</option>
                </select>
              </label>
            </div>

            <h3 class="text-cyan-200 font-bold mt-4 mb-2">Informaci√≥n de Contacto</h3>
            <div class="grid grid-2">
              <label><span class="label-text">Tel√©fono</span><input id="p-phone" placeholder="Ej: +56912345678"></label>
              <label><span class="label-text">Email</span><input id="p-email" placeholder="Ej: juan.perez@example.com"></label>
            </div>

            <h3 class="text-cyan-200 font-bold mt-4 mb-2">Contacto de Emergencia</h3>
            <div class="grid grid-3">
              <label><span class="label-text">Nombre</span><input id="p-em-name" placeholder="Ej: Carlos Garc√≠a"></label>
              <label><span class="label-text">Relaci√≥n</span><input id="p-em-relation" placeholder="Ej: Hijo/a"></label>
              <label><span class="label-text">Tel√©fono</span><input id="p-em-phone" placeholder="Ej: +56987654321"></label>
              <label><span class="label-text">WhatsApp</span><input id="p-em-wa" placeholder="Ej: +56987654321"></label>
              <label><span class="label-text">Email</span><input id="p-em-email" placeholder="Ej: carlos.garcia@example.com"></label>
            </div>

            <h3 class="text-cyan-200 font-bold mt-4 mb-2">Historial M√©dico</h3>
            <div class="grid grid-1">
              <label><span class="label-text">Patolog√≠as (separadas por coma)</span><input id="p-pathologies" placeholder="Ej: Hipertensi√≥n, Diabetes Tipo 2"></label>
              <label><span class="label-text">Alergias a medicamentos (separadas por coma)</span><input id="p-allergies" placeholder="Ej: Penicilina, AINEs"></label>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancelar</button>
            <button class="btn btn-primary" onclick="savePatient()">Guardar Paciente</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function savePatient() {
      const parseList = val => (val || '').split(',').map(s => s.trim()).filter(Boolean);
      const pathologiesInput = parseList(document.getElementById('p-pathologies').value || '');
      const allergiesInput   = parseList(document.getElementById('p-allergies').value || '');
      const patient = {
        id: uid(),
        name: document.getElementById('p-name').value,
        age: Number(document.getElementById('p-age').value),
        sex: document.getElementById('p-sex').value,
        phone: document.getElementById('p-phone').value,
        email: document.getElementById('p-email').value,
        emergency: {
          name: document.getElementById('p-em-name').value,
          relation: document.getElementById('p-em-relation').value,
          phone: document.getElementById('p-em-phone').value,
          whatsapp: document.getElementById('p-em-wa').value,
          email: document.getElementById('p-em-email').value
        },
        pathologies: pathologiesInput.map(name => ({ id: uid(), name, date: new Date().toISOString().slice(0,10) })),
        allergies: allergiesInput,
        diagnoses: [],
        notes: ''
      };
      if (!patient.name || !patient.age || !patient.sex) { notify('Complete los campos requeridos'); return; }
      state.patients.unshift(patient); saveState();
      document.querySelector('.modal-overlay').remove(); render(); notify('Paciente agregado');
    }

    function deletePatient(id) {
      if (!confirm('¬øEliminar este paciente?')) return;
      state.patients = state.patients.filter(p => p.id !== id);
      state.meds = state.meds.map(m => m.patientId === id ? { ...m, patientId: null } : m);
      state.vitals = state.vitals.filter(v => v.patientId !== id);
      saveState(); render(); notify('Paciente eliminado');
    }

    // Nueva versi√≥n con edici√≥n de pacientes
    function showAddPatient(prefill = null) {
      const isEdit = !!prefill;
      editingPatientId = isEdit ? prefill.id : null;
      const pathologiesText = prefill?.pathologies?.map(pt => pt.name).join(', ') || '';
      const allergiesText = prefill?.allergies?.join(', ') || '';
      const modal = document.createElement('div');
      modal.className = 'modal-overlay show';
      modal.innerHTML = `
        <div class="neon-card modal">
          <div class="modal-header">
            <h2 class="text-lg font-bold text-cyan-400">${isEdit ? 'Editar Paciente' : 'Agregar Nuevo Paciente'}</h2>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">‚úï</button>
          </div>
          <div class="modal-body">
            <h3 class="text-cyan-200 font-bold mb-2">Informaci√≥n B√°sica</h3>
            <div class="grid grid-3">
              <label><span class="label-text">Nombre Completo *</span><input id="p-name" placeholder="Ej: Juan P√©rez" value="${prefill?.name || ''}"></label>
              <label><span class="label-text">Edad *</span><input type="number" id="p-age" placeholder="Ej: 65" value="${prefill?.age || ''}"></label>
              <label><span class="label-text">Sexo *</span>
                <select id="p-sex">
                  <option value="">Seleccionar</option>
                  <option ${prefill?.sex === 'Femenino' ? 'selected' : ''}>Femenino</option>
                  <option ${prefill?.sex === 'Masculino' ? 'selected' : ''}>Masculino</option>
                  <option ${prefill?.sex === 'Otro' ? 'selected' : ''}>Otro</option>
                </select>
              </label>
            </div>

            <h3 class="text-cyan-200 font-bold mt-4 mb-2">Informaci√≥n de Contacto</h3>
            <div class="grid grid-2">
              <label><span class="label-text">Tel√©fono</span><input id="p-phone" placeholder="Ej: +56912345678" value="${prefill?.phone || ''}"></label>
              <label><span class="label-text">Email</span><input id="p-email" placeholder="Ej: juan.perez@example.com" value="${prefill?.email || ''}"></label>
            </div>

            <h3 class="text-cyan-200 font-bold mt-4 mb-2">Contacto de Emergencia</h3>
            <div class="grid grid-3">
              <label><span class="label-text">Nombre</span><input id="p-em-name" placeholder="Ej: Carlos Garc√≠a" value="${prefill?.emergency?.name || ''}"></label>
              <label><span class="label-text">Relaci√≥n</span><input id="p-em-relation" placeholder="Ej: Hijo/a" value="${prefill?.emergency?.relation || ''}"></label>
              <label><span class="label-text">Tel√©fono</span><input id="p-em-phone" placeholder="Ej: +56987654321" value="${prefill?.emergency?.phone || ''}"></label>
              <label><span class="label-text">WhatsApp</span><input id="p-em-wa" placeholder="Ej: +56987654321" value="${prefill?.emergency?.whatsapp || ''}"></label>
              <label><span class="label-text">Email</span><input id="p-em-email" placeholder="Ej: carlos.garcia@example.com" value="${prefill?.emergency?.email || ''}"></label>
            </div>

            <h3 class="text-cyan-200 font-bold mt-4 mb-2">Historial M√©dico</h3>
            <div class="grid grid-1">
              <label><span class="label-text">Patolog√≠as (separadas por coma)</span><input id="p-pathologies" placeholder="Ej: Hipertensi√≥n, Diabetes Tipo 2" value="${pathologiesText}"></label>
              <label><span class="label-text">Alergias a medicamentos (separadas por coma)</span><input id="p-allergies" placeholder="Ej: Penicilina, AINEs" value="${allergiesText}"></label>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancelar</button>
            <button class="btn btn-primary" onclick="savePatient()">${isEdit ? 'Guardar Cambios' : 'Guardar Paciente'}</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function showEditPatient(id) {
      const p = state.patients.find(x => x.id === id);
      if (!p) return;
      showAddPatient(p);
    }

    function savePatient() {
      const parseList = val => (val || '').split(',').map(s => s.trim()).filter(Boolean);
      const pathologiesInput = parseList(document.getElementById('p-pathologies').value || '');
      const allergiesInput   = parseList(document.getElementById('p-allergies').value || '');
      const patient = {
        id: editingPatientId || uid(),
        name: document.getElementById('p-name').value,
        age: Number(document.getElementById('p-age').value),
        sex: document.getElementById('p-sex').value,
        phone: document.getElementById('p-phone').value,
        email: document.getElementById('p-email').value,
        emergency: {
          name: document.getElementById('p-em-name').value,
          relation: document.getElementById('p-em-relation').value,
          phone: document.getElementById('p-em-phone').value,
          whatsapp: document.getElementById('p-em-wa').value,
          email: document.getElementById('p-em-email').value
        },
        pathologies: pathologiesInput.map(name => ({ id: uid(), name, date: new Date().toISOString().slice(0,10) })),
        allergies: allergiesInput,
        diagnoses: [],
        notes: ''
      };
      if (!patient.name || !patient.age || !patient.sex) { notify('Complete los campos requeridos'); return; }
      if (editingPatientId) {
        state.patients = state.patients.map(p => p.id === editingPatientId ? patient : p);
        notify('Paciente actualizado');
      } else {
        state.patients.unshift(patient);
        notify('Paciente agregado');
      }
      editingPatientId = null;
      saveState();
      document.querySelector('.modal-overlay').remove(); render();
    }

    /* -------- MEDS -------- */
    function renderMedicines() {
      return `
        <button class="btn-back" onclick="setTab('Inicio')"><span>‚Üê</span><span>Volver al Inicio</span></button>
        <div class="flex justify-between items-center mb-4 flex-col-mobile">
          <h2 class="text-2xl font-bold text-cyan-200 mb-4">Gesti√≥n de Medicamentos</h2>
          <button class="btn btn-primary" onclick="showAddMed()">+ Agregar F√°rmaco</button>
        </div>
        <div style="margin-bottom:1rem;">
          ${state.meds.map(m => `
            <div class="neon-card flex justify-between items-center">
              <div class="flex items-center gap-3">
                <div style="width:2.5rem; height:2.5rem; border-radius:50%; background: rgba(6,182,212,0.1); display:flex; align-items:center; justify-content:center; font-size:1.25rem;">üíä</div>
                <div>
                  <div class="font-bold text-cyan-200">${m.name} ${m.dose}</div>
                  <div class="text-sm text-cyan-400">${m.permanent ? 'Permanente' : (m.start || '‚Äî') + ' ‚Äî ' + (m.end || '‚Äî')}</div>
                  <div class="text-sm text-cyan-400">${m.freq} ${m.schedules.length ? '‚Ä¢ ' + m.schedules.join(', ') : ''}</div>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <label class="switch">
                  <input type="checkbox" ${m.active ? 'checked' : ''} onchange="toggleMed('${m.id}', this.checked)">
                  <span class="slider"></span>
                </label>
                <span class="text-sm" style="color:${m.active ? '#2563eb' : '#94a3b8'};">${m.active ? 'Activo' : 'Inactivo'}</span>
                <button class="action-pill pill-edit" title="Editar" onclick="showEditMed('${m.id}')"><span class="pill-icon">‚úé</span></button>
                <button class="action-pill pill-delete" title="Eliminar" onclick="deleteMed('${m.id}')"><span class="pill-icon">üóë</span></button>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function showAddMed(prefill = null) {
      const isEdit = !!prefill;
      editingMedId = prefill ? prefill.id : null;

      const modal = document.createElement('div');
      modal.className = 'modal-overlay show';

      const patientOptions = ['<option value="">Sin asignar</option>']
        .concat(state.patients.map(p => `<option value="${p.id}">${p.name}</option>`))
        .join('');

      const freqOptions = ['Diaria','2 veces al d√≠a','3 veces al d√≠a','A demanda']
        .map(f => `<option ${prefill?.freq === f ? 'selected' : ''}>${f}</option>`).join('');

      const schedules = prefill?.schedules?.length ? prefill.schedules : ['08:00'];
      const schedInputs = schedules.map((hh, idx) => `
        <div class="flex items-center gap-2 sched-row" data-idx="${idx}">
          <input type="time" value="${hh}" class="sched-input" style="max-width:140px;">
          <button class="btn btn-secondary" style="padding:0.35rem 0.75rem;" onclick="removeSchedRow(this)">‚úï</button>
        </div>
      `).join('');

      modal.innerHTML = `
        <div class="neon-card modal">
          <div class="modal-header">
            <h2 class="text-lg font-bold text-cyan-200">${isEdit ? 'Editar F√°rmaco' : 'Agregar Nuevo F√°rmaco'}</h2>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">‚úï</button>
          </div>
          <div class="modal-body">
            <div class="grid grid-2" style="align-items:center; gap:1rem 1rem;">
              <label><span class="label-text">Nombre *</span><input id="m-name" placeholder="Ej: Paracetamol" value="${prefill?.name || ''}"></label>
              <label><span class="label-text">Frecuencia *</span>
                <select id="m-freq">${freqOptions}</select>
              </label>

              <label><span class="label-text">Cantidad/Dosis *</span><input id="m-dose" placeholder="Ej: 500mg" value="${prefill?.dose || ''}"></label>
              <label><span class="label-text">Asignar a Paciente</span>
                <select id="m-patient">${patientOptions}</select>
              </label>

              <label><span class="label-text">Fecha de Inicio</span><input type="date" id="m-start" value="${prefill?.start || ''}"></label>
              <label><span class="label-text">Fecha de T√©rmino</span><input type="date" id="m-end" value="${prefill?.end || ''}"></label>

              <div class="flex items-center gap-2" style="grid-column: span 2;">
                <input type="checkbox" id="m-permanent" ${prefill?.permanent ? 'checked' : ''} />
                <span class="text-sm text-cyan-300">Tratamiento Permanente</span>
              </div>

              <div style="grid-column: span 2;">
                <div class="text-sm text-cyan-300" style="margin-bottom:0.35rem;">Horarios</div>
                <div id="sched-container" class="flex flex-col gap-2">
                  ${schedInputs}
                </div>
                <button class="btn btn-secondary mt-2" style="padding:0.35rem 0.75rem;" onclick="addSchedRow()">+ Agregar horario</button>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancelar</button>
            <button class="btn btn-primary" onclick="${isEdit ? 'saveMed(true)' : 'saveMed()'}">${isEdit ? 'Guardar Cambios' : 'Agregar F√°rmaco'}</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // set patient select value
      if (prefill?.patientId) modal.querySelector('#m-patient').value = prefill.patientId;
    }

    function addSchedRow() {
      const container = document.getElementById('sched-container');
      const div = document.createElement('div');
      div.className = 'flex items-center gap-2 sched-row';
      div.innerHTML = `
        <input type="time" value="08:00" class="sched-input" style="max-width:140px;">
        <button class="btn btn-secondary" style="padding:0.35rem 0.75rem;" onclick="removeSchedRow(this)">‚úï</button>
      `;
      container.appendChild(div);
    }
    function removeSchedRow(btn) {
      const container = document.getElementById('sched-container');
      if (container.children.length > 1) btn.parentElement.remove();
    }

    function collectSchedules() {
      return Array.from(document.querySelectorAll('.sched-input'))
        .map(i => i.value).filter(Boolean);
    }

    function saveMed(isEdit = false) {
      const schedules = collectSchedules();
      const medData = {
        name: document.getElementById('m-name').value,
        dose: document.getElementById('m-dose').value,
        freq: document.getElementById('m-freq').value,
        schedules,
        start: document.getElementById('m-start').value,
        end: document.getElementById('m-end').value,
        permanent: document.getElementById('m-permanent').checked,
        active: true,
        patientId: document.getElementById('m-patient').value || null
      };
      if (!medData.name || !medData.dose || !medData.freq) { notify('Complete los campos requeridos'); return; }

      if (isEdit && editingMedId) {
        state.meds = state.meds.map(m => m.id === editingMedId ? { ...m, ...medData } : m);
        notify('Medicamento actualizado');
      } else {
        state.meds.unshift({ id: uid(), ...medData });
        notify('Medicamento agregado');
      }
      saveState();
      document.querySelector('.modal-overlay').remove();
      render();
    }

    function showEditMed(id) {
      const med = state.meds.find(m => m.id === id);
      if (!med) return;
      showAddMed(med);
    }

    const toggleMed = (id, active) => { const m=state.meds.find(x=>x.id===id); if(m){ m.active=active; saveState(); render(); } };
    function deleteMed(id) { if (!confirm('¬øEliminar este medicamento?')) return; state.meds = state.meds.filter(m => m.id !== id); saveState(); render(); notify('Medicamento eliminado'); }

    /* -------- VITALS -------- */
    function renderVitals() {
      const patientId = state.patients[0]?.id || '';
      const rows = state.vitals.filter(v => !patientId || v.patientId === patientId || v.patientId === null);
      return `
        <button class="btn-back" onclick="setTab('Inicio')"><span>‚Üê</span><span>Volver al Inicio</span></button>
        <div class="flex justify-between items-center mb-4 flex-col-mobile">
          <h2 class="text-2xl font-bold text-cyan-200 mb-4">Control de Signos Vitales</h2>
          <button class="btn btn-primary" onclick="showAddVital()">+ Agregar Signo Vital</button>
        </div>
        <div class="neon-card">
          <div style="overflow-x:auto; -webkit-overflow-scrolling:touch;">
            <table>
              <thead>
                <tr><th>Fecha y Hora</th><th>P. Arterial</th><th>F. Card√≠aca</th><th>F. Resp.</th><th>Temp.</th><th>Sat. O‚ÇÇ</th><th>HGT</th><th>Observaciones</th><th></th></tr>
              </thead>
              <tbody>
                ${rows.length===0 ? '<tr><td colspan="9" class="text-center" style="padding:2rem;">Sin registros</td></tr>' : ''}
                ${rows.map(r => `
                  <tr>
                    <td>${new Date(r.datetime).toLocaleString()}</td>
                    <td>${r.bpSys}/${r.bpDia}</td>
                    <td>${r.hr}</td>
                    <td>${r.rr}</td>
                    <td>${r.temp}¬∞C</td>
                    <td>${r.spo2}%</td>
                    <td>${r.hgt}</td>
                    <td style="max-width:240px; overflow:hidden; text-overflow:ellipsis;" title="${r.notes}">${r.notes}</td>
                    <td><button class="text-red-400 cursor-pointer" onclick="deleteVital('${r.id}')">üóë</button></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    function showAddVital() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay show';
      const now = new Date().toISOString().slice(0,16);
      modal.innerHTML = `
        <div class="neon-card modal">
          <div class="modal-header">
            <h2 class="text-lg font-bold text-cyan-400">Agregar Registro de Signos Vitales</h2>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">‚úï</button>
          </div>
          <div class="modal-body">
            <div class="grid grid-3">
              <label><span class="label-text">Paciente</span>
                <select id="v-patient">${state.patients.map(p=>`<option value="${p.id}">${p.name}</option>`).join('')}</select>
              </label>
              <label><span class="label-text">Fecha y hora</span><input type="datetime-local" id="v-datetime" value="${now}"></label>
              <div></div>
              <label><span class="label-text">Presi√≥n Sist√≥lica *</span><input type="number" id="v-sys"></label>
              <label><span class="label-text">Presi√≥n Diast√≥lica *</span><input type="number" id="v-dia"></label>
              <label><span class="label-text">Frecuencia Card√≠aca</span><input type="number" id="v-hr"></label>
              <label><span class="label-text">F. Respiratoria</span><input type="number" id="v-rr"></label>
              <label><span class="label-text">Temperatura (¬∞C)</span><input type="number" step="0.1" id="v-temp"></label>
              <label><span class="label-text">Saturaci√≥n O‚ÇÇ (%)</span><input type="number" id="v-spo2"></label>
              <label><span class="label-text">HGT (mg/dL)</span><input type="number" id="v-hgt"></label>
              <label style="grid-column: span 3;"><span class="label-text">Observaciones</span><textarea id="v-notes"></textarea></label>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancelar</button>
            <button class="btn btn-primary" onclick="saveVital()">Guardar Registro</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function saveVital() {
      const vital = {
        id: uid(),
        patientId: document.getElementById('v-patient').value,
        datetime: new Date(document.getElementById('v-datetime').value).toISOString(),
        bpSys: Number(document.getElementById('v-sys').value),
        bpDia: Number(document.getElementById('v-dia').value),
        hr: Number(document.getElementById('v-hr').value || 0),
        rr: Number(document.getElementById('v-rr').value || 0),
        temp: Number(document.getElementById('v-temp').value || 0),
        spo2: Number(document.getElementById('v-spo2').value || 0),
        hgt: Number(document.getElementById('v-hgt').value || 0),
        notes: document.getElementById('v-notes').value
      };
      if (!vital.bpSys || !vital.bpDia) { notify('Complete los campos requeridos'); return; }
      state.vitals.unshift(vital); saveState();
      document.querySelector('.modal-overlay').remove(); render(); notify('Signo vital registrado');
    }
    function deleteVital(id) { if (!confirm('¬øEliminar este registro?')) return; state.vitals = state.vitals.filter(v => v.id !== id); saveState(); render(); notify('Registro eliminado'); }

    /* -------- AGENDA -------- */
    function renderAgenda() {
      return `
        <button class="btn-back" onclick="setTab('Inicio')"><span>‚Üê</span><span>Volver al Inicio</span></button>
        <div class="flex justify-between items-center mb-4 flex-col-mobile">
          <h2 class="text-2xl font-bold text-cyan-200 mb-4">Agenda M√©dica</h2>
          <button class="btn btn-primary" onclick="showAddAgenda()">+ Nueva Cita</button>
        </div>
        ${state.agenda.length === 0 ? '<p class="text-center text-cyan-400">Sin citas m√©dicas registradas.</p>' : ''}
        ${state.agenda.map(a => `
          <div class="neon-card flex justify-between">
            <div>
              <div class="text-lg font-bold text-cyan-200">${a.doctor}</div>
              <div class="text-sm text-cyan-400">${a.especialidad}</div>
              <div class="text-sm text-cyan-300 mt-2">üìÖ ${a.fecha} ‚Ä¢ ‚è∞ ${a.hora}</div>
              <div class="text-sm text-cyan-300">üè• ${a.consulta}</div>
              <div class="text-sm text-cyan-300">üìç ${a.direccion}</div>
              <div class="text-sm text-cyan-300">üìû ${a.telefono}</div>
              ${a.observaciones ? `<div class="text-sm text-cyan-400 mt-2">üóí ${a.observaciones}</div>` : ''}
            </div>
            <button class="text-red-400 cursor-pointer" onclick="deleteAgenda('${a.id}')">üóë</button>
          </div>
        `).join('')}
      `;
    }

    function showAddAgenda() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay show';
      modal.innerHTML = `
        <div class="neon-card modal">
          <div class="modal-header">
            <h2 class="text-lg font-bold text-cyan-400">Agregar Cita M√©dica</h2>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">‚úï</button>
          </div>
          <div class="modal-body">
            <div class="grid grid-3">
              <label><span class="label-text">Fecha de Consulta *</span><input type="date" id="a-fecha"></label>
              <label><span class="label-text">Hora de Consulta *</span><input type="time" id="a-hora"></label>
              <div></div>
              <label><span class="label-text">Doctor *</span><input id="a-doctor" placeholder="Ej: Dr. Juan P√©rez"></label>
              <label><span class="label-text">Especialidad *</span><input id="a-esp" placeholder="Ej: Cardiolog√≠a"></label>
              <label><span class="label-text">Consulta</span><input id="a-consulta"></label>
              <label><span class="label-text">Tel√©fono</span><input id="a-tel"></label>
              <label style="grid-column: span 2;"><span class="label-text">Direcci√≥n</span><input id="a-dir"></label>
              <label style="grid-column: span 3;"><span class="label-text">Observaciones</span><textarea id="a-obs"></textarea></label>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancelar</button>
            <button class="btn btn-primary" onclick="saveAgenda()">Guardar Cita</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function saveAgenda() {
      const agenda = {
        id: uid(),
        fecha: document.getElementById('a-fecha').value,
        hora: document.getElementById('a-hora').value,
        doctor: document.getElementById('a-doctor').value,
        especialidad: document.getElementById('a-esp').value,
        consulta: document.getElementById('a-consulta').value,
        telefono: document.getElementById('a-tel').value,
        direccion: document.getElementById('a-dir').value,
        observaciones: document.getElementById('a-obs').value
      };
      if (!agenda.fecha || !agenda.hora || !agenda.doctor || !agenda.especialidad) { notify('Complete los campos requeridos'); return; }
      state.agenda.unshift(agenda); saveState();
      document.querySelector('.modal-overlay').remove(); render(); notify('Cita agregada');
    }

    const deleteAgenda = id => { if(!confirm('¬øEliminar esta cita?')) return; state.agenda = state.agenda.filter(a=>a.id!==id); saveState(); render(); notify('Cita eliminada'); };

    /* -------- FARMACIA -------- */
    function renderFarmacia() {
      return `
        <button class="btn-back" onclick="setTab('Inicio')"><span>‚Üê</span><span>Volver al Inicio</span></button>
        <div style="text-align:center; padding:2rem 0;">
          <h2 class="text-2xl font-bold text-cyan-200 mb-4">üè™ Buscar Farmacia</h2>
          <p class="text-cyan-400" style="max-width:600px; margin:0 auto 2rem;">Encuentra r√°pidamente farmacias cercanas o abre el mapa general en Google Maps.</p>
          <div class="flex flex-col items-center gap-3">
            <button class="btn btn-primary" onclick="buscarFarmacia()">üîç Buscar Farmacia Cercana</button>
            <button class="btn btn-secondary" onclick="abrirMaps()">üó∫Ô∏è Ver en Google Maps</button>
          </div>
          <p id="farmacia-error" class="text-red-400 mt-4 hidden"></p>
        </div>
      `;
    }

    function buscarFarmacia() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => {
            const { latitude, longitude } = pos.coords;
            window.open(`https://www.google.com/maps/search/farmacia+cercana/@${latitude},${longitude},15z`, '_blank');
          },
          () => {
            const err = document.getElementById('farmacia-error');
            err.textContent = 'No se pudo obtener la ubicaci√≥n. Activa permisos de localizaci√≥n.';
            err.classList.remove('hidden');
          }
        );
      } else {
        const err = document.getElementById('farmacia-error');
        err.textContent = 'Tu navegador no soporta geolocalizaci√≥n.';
        err.classList.remove('hidden');
      }
    }
    const abrirMaps = () => window.open('https://www.google.com/maps/search/farmacia+cercana/', '_blank');

    /* -------- AJUSTES -------- */
    function renderAjustes() {
      return `
        <button class="btn-back" onclick="setTab('Inicio')"><span>‚Üê</span><span>Volver al Inicio</span></button>
        <div style="max-width:768px; margin:0 auto;">
          <h2 class="text-2xl font-bold text-cyan-200 mb-4">‚öôÔ∏è Ajustes del Sistema</h2>
          <div class="neon-card mb-4">
            <h3 class="font-bold text-cyan-200 mb-3">üé® Tema visual</h3>
            <div class="flex justify-between items-center">
              <span class="text-cyan-300">Modo Oscuro</span>
              <input type="checkbox" ${settings.theme === 'dark' ? 'checked' : ''} onchange="toggleTheme()">
            </div>
          </div>
          <div class="neon-card mb-4">
            <h3 class="font-bold text-cyan-200 mb-3">üîî Notificaciones</h3>
            <div class="flex justify-between items-center">
              <span class="text-cyan-300">Activar sonidos</span>
              <input type="checkbox" ${settings.sounds ? 'checked' : ''} onchange="toggleSounds(this.checked)">
            </div>
          </div>
          <div class="neon-card mb-4">
            <h3 class="font-bold text-cyan-200 mb-3">üë§ Datos del usuario</h3>
            <label><span class="label-text">Nombre</span><input id="user-nombre" value="${settings.user.nombre}"></label>
            <label><span class="label-text">Centro m√©dico habitual</span><input id="user-centro" value="${settings.user.centro}"></label>
            <label><span class="label-text">M√©dico tratante</span><input id="user-medico" value="${settings.user.medico}"></label>
          </div>
          <div class="flex justify-end gap-3">
            <button class="btn btn-secondary" onclick="resetApp()">Restablecer</button>
            <button class="btn btn-primary" onclick="saveUserSettings()">Guardar Ajustes</button>
          </div>
        </div>
      `;
    }

    const toggleSounds = checked => { settings.sounds = checked; saveSettings(); };
    function saveUserSettings() {
      settings.user = {
        nombre: document.getElementById('user-nombre').value,
        centro: document.getElementById('user-centro').value,
        medico: document.getElementById('user-medico').value
      };
      saveSettings(); notify('Ajustes guardados');
    }
    function resetApp() { if (!confirm('¬øRestablecer toda la aplicaci√≥n? Se perder√°n todos los datos.')) return; localStorage.clear(); window.location.reload(); }

    /* INIT */
    document.documentElement.classList.toggle('dark', settings.theme === 'dark');
    document.getElementById('themeBtn').textContent = settings.theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    renderNav(); render();
  </script>
</body>
</html>